name: Deploy to cPanel via SSH (no rsync)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH (git pull + copy backend)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.CPANEL_SSH_KEY }}
          port: ${{ secrets.CPANEL_SSH_PORT }}
          script: |
            set -e

            # Paths
            REPO_DIR="/home/${{ secrets.CPANEL_USER }}/_deploy_tmp/limo"
            TARGET_DIR="${{ secrets.CPANEL_APP_PATH }}"

            # Ensure folders
            mkdir -p "/home/${{ secrets.CPANEL_USER }}/_deploy_tmp"
            mkdir -p "$TARGET_DIR"

            # Clone once, then pull
            if [ ! -d "$REPO_DIR/.git" ]; then
              git clone https://github.com/ninjasofts/limo.git "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            git fetch --all
            git reset --hard origin/main

            # Copy backend folder into target (Laravel lives in repo/backend)
            rm -rf "$TARGET_DIR"/*
            cp -R "$REPO_DIR/backend/." "$TARGET_DIR/"

            # Laravel post-deploy (safe defaults)
            cd "$TARGET_DIR"

            if [ -f artisan ]; then
              php artisan migrate --force || true
              php artisan optimize:clear || true
            fi

            chmod -R 775 storage bootstrap/cache || true
